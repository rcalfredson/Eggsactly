<!doctype html>
<script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.7/paper-full.js"></script>
<script type="text/javascript">
    const socket = io();
    let annotations = {};
    let orderedImgNames = [];
    let rectangles = [];
    let texts = [];
    let imgName;
    let zoom = 1.0;
    let lastScrollTime;
    let canvas;
    let canvasWidth = Math.min(1300, window.innerWidth),
        canvasHeight = Math.min(800, window.innerHeight);
    let pointerDown = false;
    let dragStart = false;
    let timeDownUp;
    let origCenter;
    let currentImgIndex = 0;
    let backgroundRaster, pic;
</script>
<title>Egg Counting</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/main.css') }}">
<label for="img-upload">Upload one or more egg-counting images<br>
    <span style="font-size: small; padding-left: 15px;">
        Note: hold down Ctrl key to select multiple files.
    </span>
</label>
<form id=img-form method=post enctype="multipart/form-data">
    <input type=file multiple="multiple" id="img-upload" name="img-upload">
    <button id='img-upload-btn' type=button>Upload</button>
</form>
<div id=updates></div>
<script type="text/javascript">
    $(function () {
        $('#img-upload-btn').click(function () {
            var form_data = new FormData($('#img-form')[0]);
            $.ajax({
                type: 'POST',
                url: '/upload',
                data: form_data,
                contentType: false,
                cache: false,
                processData: false,
                success: function (data) {
                    console.log('Success!');
                },
            });
            imgName = document.getElementById('img-upload').files.item(0).name
        });
    });

    $(document).ready(() => {
        socket.on('counting-progress', (msg) => {
            $('#updates').append('<p>' + msg.data + '</p>')
        });
        socket.on('counting-csv', (msg) => {
            $('#updates').append(`<form action=/csvResults/${msg.data}><input value='Download results' type=submit>` +
                '</input></form>');
            setupCanvas(msg.data)
        });
        socket.on('counting-annotations', (msg) => {
            annotations[msg.filename] = JSON.parse(msg.data);
            orderedImgNames.push(msg.filename);
        });
        socket.on('clear-all', () => {
            if (!!document.getElementById('updates')) {
                $('#updates').empty();
            }
            annotations = {};
            orderedImgNames = [];
        });
        socket.on('clear-display', () => {
            $('#updates').empty();
        });
    });

    var setCurrentImgName = function() {
        document.getElementById('current-img').innerText =
            `Viewing image ${orderedImgNames[currentImgIndex]} (Shift + scroll to zoom)`;
    }

    var setButtonHandlers = function () {
        if (orderedImgNames.length === 1) {
            document.getElementById('prev-img').setAttribute('disabled', true);
            document.getElementById('next-img').setAttribute('disabled', true);
            return
        }
        document.getElementById('prev-img').onclick = (evt) => {
            let newImgIdx = currentImgIndex - 1;
            if (newImgIdx >= 0) {
                currentImgIndex = newImgIdx;
                redrawCanvas();
                if (newImgIdx == 0) {
                    evt.target.setAttribute('disabled', true);
                    document.getElementById('next-img').removeAttribute('disabled');
                } else {
                    evt.target.removeAttribute('disabled');
                }
            }
        }
        document.getElementById('next-img').onclick = (evt) => {
            let newImgIdx = currentImgIndex + 1;
            if (newImgIdx <= orderedImgNames.length) {
                currentImgIndex = newImgIdx;
                redrawCanvas();
                if (evt.target.disabled) {
                    evt.target.removeAttribute('disabled');
                }
                if (newImgIdx > 0) {
                    document.getElementById('prev-img').removeAttribute('disabled');
                }
            }
            console.log(`newImgIdx: ${newImgIdx}`);
            console.log(`length of ordered image names: ${orderedImgNames.length}`);
            if (newImgIdx >= orderedImgNames.length - 1) {
                evt.target.setAttribute('disabled', true);
                document.getElementById('prev-img').removeAttribute('disabled');
            }
        }
    }

    var redrawCanvas = function () {
        setCurrentImgName()
        if (backgroundRaster) {
            backgroundRaster.remove()
        }
        rectangles.forEach(rect => {
            rect.remove();
        })
        rectangles = [];
        texts.forEach(text => {
            text.remove();
        })
        texts = [];
        $('#updates').append(`<img id=pic src="/uploads/${orderedImgNames[currentImgIndex]}">`);
        backgroundRaster = new paper.Raster('pic');
        pic = document.getElementById('pic');
        backgroundRaster.onLoad = () => {
            backgroundRaster.fitBounds(paper.view.viewSize);
            let scalingFactor = Math.min(canvasHeight / pic.height, canvasWidth / pic.width);
            document.getElementById('pic').remove();
            let upperPadding = 0.5 * (canvasHeight - backgroundRaster.bounds.height);
            let leftPadding = 0.5 * (canvasWidth - backgroundRaster.bounds.width);
            annotations[orderedImgNames[currentImgIndex]].forEach(annotation => {
                let x = annotation.x * scalingFactor + leftPadding;
                let y = annotation.y * scalingFactor + upperPadding;
                let bbox = annotation.bbox;
                bbox = bbox.map(n => n * scalingFactor);
                let pointText = new paper.PointText(new paper.Point(x, y))
                pointText.justification = 'center';
                pointText.fillColor = 'black';
                pointText.content = annotation.count;
                pointText.fontSize = 17;
                texts.push(pointText);
                let rectangle = new paper.Rectangle(
                    new paper.Point(bbox[0]+leftPadding, bbox[1]+upperPadding),
                    new paper.Point(bbox[0] + bbox[2] + leftPadding, bbox[1] + bbox[3] + upperPadding)
                )
                rectPath = new paper.Path.Rectangle(rectangle, new paper.Size(2,2));
                rectPath.strokeColor = '#313036';
                rectangles.push(rectPath);
            });
            origCenter = paper.view.center;
        }
    }

    var setupCanvas = function () {
        let scalingFactor;
        $('#updates').append('<div id=viewer-nav></div>')
        $('#viewer-nav').append('<button class=nav-button id=reset-view>Reset view</button>')
        $('#viewer-nav').append('<button class=nav-button disabled id=prev-img>Previous image</button>');
        $('#viewer-nav').append('<button class=nav-button id=next-img>Next image</button><br>');
        $('#viewer-nav').append('<p id=current-img></p>');
        setCurrentImgName()
        setButtonHandlers()
        $('#reset-view').click(reposition)
        $('#updates').append('<canvas keepalive=true id=detectionResults></canvas>');
        canvas = document.getElementById('detectionResults');
        paper.install(window);
        paper.setup(canvas);
        paper.view.viewSize = new paper.Size(canvasWidth, canvasHeight);
        redrawCanvas();
        setPointerHandlers();
        setDragHandler();
    }

    var zoomInAndOut = e => {
        if (!e.shiftKey) {
            return;
        }
        e.preventDefault();
        if (lastScrollTime && Date.now() - lastScrollTime < 250) {
            return;
        }
        lastScrollTime = Date.now();
        let view = paper.view;
        let viewPosition = view.viewToProject(
            new paper.Point(e.offsetX, e.offsetY)
        );

        let transform = changeZoom(e.deltaY, viewPosition);
        if (paper.view.zoom <= 1 && transform.zoom <= 1) {
            return;
        }
        if (transform.zoom < 10 && transform.zoom > 0.01) {
            newScale = 1 / transform.zoom;
            paper.view.zoom = transform.zoom;
            paper.view.center = view.center.add(transform.offset);
        }
    }

    var changeZoom = (delta, p) => {
        let oldZoom = paper.view.zoom;
        let c = paper.view.center;
        let factor = 1 + zoom;

        let zoomTemp = delta < 0 ? oldZoom * factor : oldZoom / factor;
        let beta = oldZoom / zoomTemp;
        let pc = p.subtract(c);
        let a = p.subtract(pc.multiply(beta)).subtract(c);

        return { zoom: zoomTemp, offset: a };
    }

    var setPointerHandlers = function () {
        canvas.addEventListener('wheel', zoomInAndOut, { passive: false });
        paper.view.on('mousedown', function () {
            pointerDown = true;
            timeDownUp = new Date().getTime();
            dragStart = true;
        });
        paper.view.on('mouseup', function () {
            pointerDown = false;
            timeDownUp = new Date().getTime();
            dragStart = false;
        });
    }

    var setDragHandler = () => {
        var toolPan = new paper.Tool();
        toolPan.onMouseDrag = function (evt) {
            var timeMove = new Date().getTime();
            if (timeMove > timeDownUp) {
                if (dragStart) {
                    var offset = new paper.Point(evt.downPoint.x - evt.point.x,
                        evt.downPoint.y - evt.point.y);
                    let new_center = paper.view.center.add(offset);
                    paper.view.setCenter(new_center);
                }
            } else {
                timeDownUp = null;
            }
        };
    }

    function reposition() {
        paper.view.zoom = 1;
        paper.view.center = origCenter;
        dragStart = false;
    }
</script>