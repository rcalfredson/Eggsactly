<!doctype html>

<head>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.7/paper-full.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.7.2/bluebird.min.js"
        integrity="sha512-TFp7JOp8so/oHJrngLI0kn9diZrc0YDr1NrGj1YbzbvSBdGfligjYVRp1xtqlmNCPWpx4xJDhiWSGgUYvqCbBg=="
        crossorigin="anonymous"></script>
    <script src="../static/js/micromodal.min.js"></script>
    <title>Egg Counting</title>
</head>

<body>
    <button id=run-test type="button">Run Test</button>
    <div id=viewer></div>
    <script>
        let canvasWidth = Math.min(1300, window.innerWidth),
            canvasHeight = Math.min(800, window.innerHeight);
        $('#viewer').append('<canvas keepalive=true id=detectionResults></canvas>');
        let canvas = document.getElementById('detectionResults');
        paper.install(window);
        paper.setup(canvas);
        let backgroundRaster, pic;
        paper.view.viewSize = new paper.Size(canvasWidth, canvasHeight);
        var testImgNames = ['9_9_2020_IMG_0007.JPG',
            '9_9_2020_IMG_0008.JPG']

        var redrawCanvas = (index) => {
            return new Promise((resolve, reject) => {
                console.log(`top of redraw canvas for index ${index}`);
                paper.project.clear();
                if (backgroundRaster) {
                    backgroundRaster.remove();
                }
                $('#viewer').append(`<img id=pic src="/uploads/${testImgNames[index]}">`);
                backgroundRaster = new paper.Raster('pic');
                pic = document.getElementById('pic');
                backgroundRaster.onLoad = () => {
                    setTimeout(() => {
                        backgroundRaster.fitBounds(paper.view.viewSize);
                        pic.remove();
                        // setTimeout(() => {
                            console.log('after delay, the background is loaded.')
                            console.log('now resolving.')
                            resolve('OK');
                        // }, 500);
                        console.log('after delay, the background is loaded.')
                        console.log('now resolving.')
                        resolve('OK');
                    }, 2000);
                }
            });
        };
        document.getElementById('run-test').onclick = async () => {
            let indices = [0, 1];
            await Promise.each(indices, async function (index) {
                await redrawCanvas(index);
            });
        }
    </script>
</body>